<UserControl xmlns="https://github.com/avaloniaui"
             xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
             xmlns:vm="using:ResearchHub.App.ViewModels"
             xmlns:d="http://schemas.microsoft.com/expression/blend/2008"
             xmlns:mc="http://schemas.openxmlformats.org/markup-compatibility/2006"
             mc:Ignorable="d" d:DesignWidth="1000" d:DesignHeight="700"
             x:Class="ResearchHub.App.Views.ScreeningView"
             x:DataType="vm:ScreeningViewModel">

    <Grid RowDefinitions="Auto,Auto,*,Auto">
        <!-- Progress Stats -->
        <Border Grid.Row="0" Padding="15" Background="{DynamicResource SystemControlBackgroundChromeMediumBrush}">
            <Grid ColumnDefinitions="*,*,*,*,*">
                <StackPanel Grid.Column="0" HorizontalAlignment="Center">
                    <TextBlock Text="Total" FontSize="12" Foreground="Gray" HorizontalAlignment="Center"/>
                    <TextBlock Text="{Binding TotalCount}" FontSize="24" FontWeight="Bold" HorizontalAlignment="Center"/>
                </StackPanel>
                <StackPanel Grid.Column="1" HorizontalAlignment="Center">
                    <TextBlock Text="Pending" FontSize="12" Foreground="Gray" HorizontalAlignment="Center"/>
                    <TextBlock Text="{Binding PendingCount}" FontSize="24" FontWeight="Bold" Foreground="Orange" HorizontalAlignment="Center"/>
                </StackPanel>
                <StackPanel Grid.Column="2" HorizontalAlignment="Center">
                    <TextBlock Text="Included" FontSize="12" Foreground="Gray" HorizontalAlignment="Center"/>
                    <TextBlock Text="{Binding IncludedCount}" FontSize="24" FontWeight="Bold" Foreground="Green" HorizontalAlignment="Center"/>
                </StackPanel>
                <StackPanel Grid.Column="3" HorizontalAlignment="Center">
                    <TextBlock Text="Excluded" FontSize="12" Foreground="Gray" HorizontalAlignment="Center"/>
                    <TextBlock Text="{Binding ExcludedCount}" FontSize="24" FontWeight="Bold" Foreground="Red" HorizontalAlignment="Center"/>
                </StackPanel>
                <StackPanel Grid.Column="4" HorizontalAlignment="Center">
                    <TextBlock Text="Maybe" FontSize="12" Foreground="Gray" HorizontalAlignment="Center"/>
                    <TextBlock Text="{Binding MaybeCount}" FontSize="24" FontWeight="Bold" Foreground="Blue" HorizontalAlignment="Center"/>
                </StackPanel>
            </Grid>
        </Border>

        <!-- Progress Bar -->
        <ProgressBar Grid.Row="1" Value="{Binding ProgressPercentage}" Maximum="100" Height="8"/>

        <!-- Reference Card -->
        <Border Grid.Row="2" Margin="20" Padding="30"
                Background="{DynamicResource SystemControlBackgroundChromeMediumBrush}"
                CornerRadius="8">
            <Grid>
                <!-- Reference Content -->
                <ScrollViewer IsVisible="{Binding CurrentReference, Converter={x:Static ObjectConverters.IsNotNull}}">
                    <StackPanel Spacing="15" DataContext="{Binding CurrentReference}">
                        <TextBlock Text="{Binding Title}" FontSize="18" FontWeight="Bold" TextWrapping="Wrap"/>

                        <TextBlock Text="{Binding Authors[0], StringFormat={}{0} et al.}"
                                   FontStyle="Italic" TextWrapping="Wrap" Foreground="Gray"/>

                        <StackPanel Orientation="Horizontal" Spacing="10">
                            <TextBlock Text="{Binding Journal}" FontWeight="SemiBold"/>
                            <TextBlock Text="{Binding Year, StringFormat='({0})'}"/>
                        </StackPanel>

                        <Separator Margin="0,10"/>

                        <TextBlock Text="Abstract" FontWeight="Bold" FontSize="14"/>
                        <TextBlock Text="{Binding Abstract, FallbackValue='No abstract available'}"
                                   TextWrapping="Wrap" LineHeight="24"/>

                        <StackPanel Orientation="Horizontal" Spacing="20" Margin="0,10,0,0">
                            <TextBlock Text="{Binding Doi, StringFormat='DOI: {0}'}"
                                       IsVisible="{Binding Doi, Converter={x:Static StringConverters.IsNotNullOrEmpty}}"/>
                            <TextBlock Text="{Binding Pmid, StringFormat='PMID: {0}'}"
                                       IsVisible="{Binding Pmid, Converter={x:Static StringConverters.IsNotNullOrEmpty}}"/>
                        </StackPanel>
                    </StackPanel>
                </ScrollViewer>

                <!-- No more references message -->
                <StackPanel VerticalAlignment="Center" HorizontalAlignment="Center"
                            IsVisible="{Binding CurrentReference, Converter={x:Static ObjectConverters.IsNull}}">
                    <TextBlock Text="Screening Complete!" FontSize="24" FontWeight="Bold"
                               HorizontalAlignment="Center"/>
                    <TextBlock Text="All references have been screened for this phase."
                               FontSize="14" Foreground="Gray" HorizontalAlignment="Center"/>
                </StackPanel>
            </Grid>
        </Border>

        <!-- Decision Buttons -->
        <Border Grid.Row="3" Padding="20" Background="{DynamicResource SystemControlBackgroundChromeMediumBrush}">
            <Grid ColumnDefinitions="*,Auto,*">
                <!-- Exclusion Reason -->
                <ComboBox Grid.Column="0"
                          ItemsSource="{Binding CommonExclusionReasons}"
                          SelectedItem="{Binding ExclusionReason}"
                          PlaceholderText="Select exclusion reason (if excluding)"
                          Width="300" HorizontalAlignment="Left"/>

                <!-- Decision Buttons -->
                <StackPanel Grid.Column="1" Orientation="Horizontal" Spacing="20"
                            HorizontalAlignment="Center">
                    <Button Content="Exclude (E)"
                            Command="{Binding ExcludeCommand}"
                            Background="#E74C3C" Foreground="White"
                            Padding="30,15" FontSize="16" FontWeight="Bold"/>
                    <Button Content="Maybe (M)"
                            Command="{Binding MaybeCommand}"
                            Background="#3498DB" Foreground="White"
                            Padding="30,15" FontSize="16" FontWeight="Bold"/>
                    <Button Content="Include (I)"
                            Command="{Binding IncludeCommand}"
                            Background="#27AE60" Foreground="White"
                            Padding="30,15" FontSize="16" FontWeight="Bold"/>
                </StackPanel>

                <!-- Keyboard Hint -->
                <TextBlock Grid.Column="2" Text="Keyboard: I=Include, E=Exclude, M=Maybe"
                           FontSize="12" Foreground="Gray"
                           VerticalAlignment="Center" HorizontalAlignment="Right"/>
            </Grid>
        </Border>

        <!-- Loading Indicator -->
        <Border Grid.RowSpan="4" Background="#80000000"
                IsVisible="{Binding IsLoading}">
            <StackPanel VerticalAlignment="Center" HorizontalAlignment="Center">
                <ProgressBar IsIndeterminate="True" Width="200"/>
                <TextBlock Text="Loading..." Foreground="White" Margin="0,10"/>
            </StackPanel>
        </Border>
    </Grid>
</UserControl>
